let nconf       = require("nconf");
let MongoClient = require("mongodb").MongoClient;

let database = null;
let sleep = (millis) => new Promise(resolve => setTimeout(resolve, millis));
nconf.argv().env()

let domain = nconf.get("DB_URL") || "localhost"

let getDb = (db) => () => {
	if (database === null) {
		let tryFn = () => 
			MongoClient.connect(`mongodb://${domain}:27017`)
				.then(client => client.db(db))
				.then((db) => {
					database = new Proxy(db, {
						get: (obj, entry) => obj.collection(entry)
					})
					return database;
				}).catch(e => {
					console.log(`Failure: ${e}`);
					return sleep(1000).then(tryFn);
				})
		return tryFn();
	} else {
		return Promise.resolve(database)
	}
}

module.exports = getDb 
