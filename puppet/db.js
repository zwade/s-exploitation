let nconf       = require("nconf");
let MongoClient = require("mongodb").MongoClient;

let database = undefined;
let sleep = (millis) => new Promise(resolve => setTimeout(resolve, millis));
nconf.argv().env()

let domain = nconf.get("DB_URL") || "localhost"

let getDb = (db) => {
	let tryFn = () => 
		MongoClient.connect(`mongodb://${domain}:27017`)
			.then(client => {
				database = client;
				return client;
			}).catch(e => {
				console.log(`Failure: ${e}`);
				return sleep(1000).then(tryFn);
			})
	let promise = database === undefined ? tryFn() : Promise.resolve(database) 
	return promise
		.then(client => client.db(db))
		.then((db) => new Proxy(db, {
				get: (obj, entry) => obj.collection(entry)
			}))
}

module.exports = getDb;
